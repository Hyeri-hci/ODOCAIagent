"""
CPE Mapper - MySQL DB를 사용하여 패키지명을 CPE URI로 변환
"""
import os
import pymysql
from typing import Optional, Dict, List
from dotenv import load_dotenv
from pymysql.cursors import DictCursor

load_dotenv()


class CpeMapper:
    """패키지명을 CPE URI로 매핑하는 클래스"""

    def __init__(self):
        """MySQL DB 연결 초기화"""
        self.host = os.getenv("DB_CPE_HOST", "localhost")
        self.port = int(os.getenv("DB_CPE_PORT", "3306"))
        self.user = os.getenv("DB_CPE_USER", "root")
        self.password = os.getenv("DB_CPE_PW", "")
        self.database = "vulnerabilities"

        self.connection = None
        print(f"[CpeMapper] Configured to connect to {self.host}:{self.port}")

    def _get_connection(self):
        """DB 연결 가져오기 (연결 풀 방식)"""
        try:
            if self.connection is None or not self.connection.open:
                self.connection = pymysql.connect(
                    host=self.host,
                    port=self.port,
                    user=self.user,
                    password=self.password,
                    database=self.database,
                    charset='utf8mb4',
                    cursorclass=DictCursor,
                    connect_timeout=5
                )
                print(f"[CpeMapper] Connected to MySQL: {self.database}")
            return self.connection
        except Exception as e:
            print(f"[CpeMapper] Connection error: {e}")
            return None

    def get_cpe_for_package(
        self,
        package_name: str,
        version: str = "*",
        ecosystem: str = "npm"
    ) -> Optional[str]:
        """
        패키지명으로 CPE URI 조회

        Args:
            package_name: 패키지명 (예: "react", "@babel/core")
            version: 버전 (예: "19.0.0", "*")
            ecosystem: 생태계 (npm, pypi 등)

        Returns:
            CPE URI 문자열 또는 None
        """
        # @ 기호가 있는 스코프 패키지 처리 (예: @babel/core -> babel_core)
        # 1. 앞의 @ 제거
        # 2. / 문자를 _ 로 변환 (CPE에서는 / 대신 _ 사용)
        clean_package_name = package_name.lstrip('@').replace('/', '_')

        try:
            conn = self._get_connection()
            if conn is None:
                return None

            with conn.cursor() as cursor:
                # 1차 시도: 정확한 패키지명 매칭
                sql = """
                    SELECT part, vendor, product, version
                    FROM cpe
                    WHERE product = %s
                    LIMIT 1
                """
                cursor.execute(sql, (clean_package_name,))
                result = cursor.fetchone()

                if result:
                    # CPE URI 생성
                    cpe_uri = f"cpe:2.3:{result['part']}:{result['vendor']}:{result['product']}:{version}"
                    print(f"[CpeMapper] Mapped {package_name} -> {cpe_uri}")
                    return cpe_uri

                # 2차 시도: 부분 매칭 (스코프 패키지의 경우)
                # 원본 패키지명이 '/'를 포함하는 경우 (예: @babel/core)
                if '/' in package_name:
                    # @babel/core -> core 로 변환
                    product_only = package_name.split('/')[-1]
                    cursor.execute(sql, (product_only,))
                    result = cursor.fetchone()

                    if result:
                        cpe_uri = f"cpe:2.3:{result['part']}:{result['vendor']}:{result['product']}:{version}"
                        print(f"[CpeMapper] Mapped {package_name} -> {cpe_uri} (partial match)")
                        return cpe_uri

                # 매핑 실패
                print(f"[CpeMapper] No CPE mapping found for: {package_name}")
                return None

        except Exception as e:
            print(f"[CpeMapper] Query error for {package_name}: {e}")
            return None

    def get_cpe_batch(
        self,
        packages: List[Dict[str, str]]
    ) -> Dict[str, Optional[str]]:
        """
        여러 패키지를 한번에 조회 (배치)

        Args:
            packages: [{"name": "react", "version": "19.0.0"}, ...]

        Returns:
            {"react": "cpe:2.3:a:facebook:react:19.0.0", ...}
        """
        result = {}

        for pkg in packages:
            name = pkg.get("name")
            version = pkg.get("version", "*")

            if name:
                cpe_uri = self.get_cpe_for_package(name, version)
                result[name] = cpe_uri

        return result

    def search_vendor_product(
        self,
        vendor: Optional[str] = None,
        product: Optional[str] = None
    ) -> List[Dict]:
        """
        Vendor 또는 Product로 CPE 검색

        Args:
            vendor: 벤더명 (예: "facebook")
            product: 제품명 (예: "react")

        Returns:
            CPE 레코드 리스트
        """
        try:
            conn = self._get_connection()
            if conn is None:
                return []

            with conn.cursor() as cursor:
                conditions = []
                params = []

                if vendor:
                    conditions.append("vendor LIKE %s")
                    params.append(f"%{vendor}%")

                if product:
                    conditions.append("product LIKE %s")
                    params.append(f"%{product}%")

                if not conditions:
                    return []

                sql = f"""
                    SELECT part, vendor, product, version
                    FROM cpe
                    WHERE {' AND '.join(conditions)}
                    LIMIT 100
                """

                cursor.execute(sql, params)
                results = cursor.fetchall()

                return results

        except Exception as e:
            print(f"[CpeMapper] Search error: {e}")
            return []

    def close(self):
        """DB 연결 종료"""
        if self.connection and self.connection.open:
            self.connection.close()
            print("[CpeMapper] Connection closed")

    def __del__(self):
        """소멸자: 연결 자동 종료"""
        self.close()


# 전역 싱글톤 인스턴스
_cpe_mapper_instance = None


def get_cpe_mapper() -> CpeMapper:
    """CpeMapper 싱글톤 인스턴스 반환"""
    global _cpe_mapper_instance
    if _cpe_mapper_instance is None:
        _cpe_mapper_instance = CpeMapper()
    return _cpe_mapper_instance
